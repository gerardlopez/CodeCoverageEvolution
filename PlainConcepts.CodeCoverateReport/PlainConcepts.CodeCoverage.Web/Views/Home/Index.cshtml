@using PlainConcepts.CodeCoverage.Web.Models;
@model Dictionary<string, Module>
<link href="~/Content/jqplot/jquery.jqplot.css" rel="stylesheet" />
<script class="include" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="~/Scripts/jqplot/jquery.jqplot.min.js"></script>
<!-- Additional plugins go here -->
<script class="include" src="~/Scripts/jqplot/plugins/jqplot.canvasTextRenderer.js"></script>
<script class="include" src="~/Scripts/jqplot/plugins/jqplot.canvasAxisLabelRenderer.js"></script>
<script class="include" src="~/Scripts/jqplot/plugins/jqplot.logAxisRenderer.js"></script>
<script class="include" src="~/Scripts/jqplot/plugins/jqplot.canvasAxisTickRenderer.js"></script>
<script class="include" src="~/Scripts/jqplot/plugins/jqplot.categoryAxisRenderer.js"></script>
<script src="~/Scripts/jqplot/plugins/jqplot.enhancedLegendRenderer.js"></script>

<!-- jquery.form -->
<script src="~/Scripts/jqueryform/jquery.form.js"></script>
<script src="~/Scripts/jquery.validate.js"></script>
<script src="~/Scripts/jquery-ui-1.10.2.js"></script>
<script src="~/Scripts/jqueryform/jquery.form.wizard.js"></script>

<link href="~/Content/Site.css" rel="stylesheet" />
@{
    ViewBag.Title = "title";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="codeCoverageData">
    <form id="dataCoverageForm" method="post" action="/Home/GetCodeCoverage" class="bbq">
        <div id="state"></div>
        <div id="fieldWrapper">
            <div class="step" id="selectServer">
                <label for="collectionUrl">Write TFS Collection Url</label><br />
                <input name="collectionUrl" id="collectionUrl" />
            </div>
            <div class="step" id="selectProject">
                <label for="collectionUrl">Select a team project</label><br />
                <input hidden="true" name="collectionUrl" id="collectionUrlProject" />
                <div id="selectProjectLocation"></div>
            </div>
            <div class="step" id="selectBuild" >
                <label for="collectionUrl">Select a build</label><br />
                <input hidden="true" name="collectionUrl" id="collectionUrlBuild" />
                <input hidden="true" name="projectName" id="projectName" />
                <div id="selectBuildLocation"></div>
            </div>
        </div>
        <div id="navigation">
            <input class="navigation_button" id="next" value="Submit" type="submit" /> 							
            <input class="navigation_button" id="back" value="Reset" type="reset" />
        </div>
    </form>
</div>
<div id="codeCoverageChart" style="height:500px; width:70%; margin-left: auto; margin-right: auto"></div>


<script type="text/javascript">
			$(function(){
			    $("#dataCoverageForm").formwizard({
				 	formPluginEnabled: true,
				 	focusFirstInput: true,
				 	disableUIStyles:true,
				 	remoteAjax: {
				 	    "selectServer": { // add a remote ajax call when moving next from the second step
				 	        url: "/Home/SelectCollection",
				 		    dataType : 'json',
				 		    success: function (data) {
				 		        if (data.Status == true) {
				 		            
				 		            var select = $("<select id=\"projectUri\" name=\"projectUri\" />");
				 		                
				 		            for (var i = 0; i < data.Projects.length; i++) {
				 		                $("<option />", { value: data.Projects[0].Name, text: data.Projects[0].Name }).appendTo(select);
				 		            }

				 		            $("#selectProjectLocation").html(select);
				 		            $("#collectionUrlProject").val($("#collectionUrl").val());
				 		            return true; //return true to make the wizard move to the next step    
				 		        } else {
				 		            alert("success!");
				 		            return false; //return true to make the wizard move to the next step
				 		        }
				 		    }
				 	    },
				 	    "selectProject": { // add a remote ajax call when moving next from the second step
				 	        url: "/Home/SelectProject",
				 	        dataType: 'json',
				 	        beforeSubmit: function (data) { $("#data").html("data sent to the server: " + $.param(data)) },
				 	        success: function (data) {
				 	            if (data.Status == true) {
				 	                var select = $("<select id=\"buildName\" name=\"buildName\" />");

				 	                for (var i = 0; i < data.Builds.length; i++) {
				 	                    $("<option />", { value: data.Builds[i].BuildUri, text: data.Builds[i].Name }).appendTo(select);
				 	                }

				 	                $("#selectBuildLocation").html(select);
				 	                $("#collectionUrlBuild").val($("#collectionUrl").val());
				 	                $("#projectName").val($("#projectUri").val());
				 	                return true; //return true to make the wizard move to the next step    
				 	            } else {
				 	                alert("success!");
				 	                return false; //return true to make the wizard move to the next step
				 	            }
				 	        }
				 	    }
				 	},
				 	formOptions :{
						success: function(data) {
						    $("#codeCoverageData").fadeTo(500, 0, function() {
						        showChart(data);
						    });
						},
						dataType: 'json',
						resetForm: false
				 	}
				 }
				);
			});
			
    function showChart(data) {
        var series = [];
        var labels = [];

        for (var dll in data) {
            labels.push(data[dll].Key);
            var points = [];
            for (var buildIndex in data[dll].Value.Builds) {
                var build = data[dll].Value.Builds[buildIndex];
                points.push([build.Name, build.Coverage]);
            }
            series.push(points);
        }
        
        var plot3 = $.jqplot('codeCoverageChart', series,
            {
                title: 'Code coverage',
                // Set default options on all series, turn on smoothing.
                seriesDefaults: {
                    rendererOptions: {
                        smooth: true
                    }
                },
                legend: {
                    renderer: $.jqplot.EnhancedLegendRenderer,
                    show: true,
                    showLabels: true,
                    location: 'e',     // compass direction, nw, n, ne, e, se, s, sw, w.
                    showSwatch: true,
                    placement: "outside",
                    labels: labels,
                    marginLeft: "30px",
                    rendererOptions: { "showMarkerStyle": true, "showLineStyle": true },
                    shrinkGrid: true
                },
                axes: {
                    xaxis: {
                        renderer: $.jqplot.CategoryAxisRenderer,
                        label: 'Build number',
                        labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                        tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                        tickOptions: {
                            angle: -30,
                            fontFamily: 'Courier New',
                            fontSize: '9pt'
                        }
                    }
                }
            }
        );
    }
    </script>